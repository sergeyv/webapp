<%page args="field" />

<select id='date_select' name='date_select'>
	<option value='today'>Today</option>
	<option value='tomorrow'>Tomorrow</option>
	<option value='this week'>This week</option>
	<option value='next week'>Next week</option>
	<option value='later'>Later</option>
	<option value='datepicker'>Specific date and time</option>
</select>
<div id="${field.cssname}-display" style="margin-left: 150px"></div>

<div id="timepicker" class="field" style="margin-top: 8px;">
	<label>Time</label>
	<div class="inputs">
		<select id='hour_select' style="width: 50px;">
			<option value='1'>01</option>
			<option value='2'>02</option>
			<option value='3'>03</option>
			<option value='4'>04</option>
			<option value='5'>05</option>
			<option value='6'>06</option>
			<option value='7'>07</option>
			<option value='8'>08</option>
			<option value='9' selected='selected'>09</option>
			<option value='10'>10</option>
			<option value='11'>11</option>
			<option value='12'>12</option>
		</select>&nbsp;
		<select id='minute_select' style="width: 50px;">
			<option value='00' selected='selected'>00</option>
			<option value='15'>15</option>
			<option value='30'>30</option>
			<option value='45'>45</option>
		</select>&nbsp;
		<select id='ampm_select' style="width: 50px;">
			<option value='AM' selected='selected'>AM</option>
			<option value='PM'>PM</option>
		</select>
	</div>
</div>

<input id="${field.cssname}" type="hidden" name="${field.name}" value="" />

<script type="text/javascript">
	$("#date_select").chosen({
		disable_search_threshold: 10
	});$("#hour_select").chosen({
		disable_search_threshold: 15
	});$("#minute_select").chosen({
		disable_search_threshold: 10
	});$("#ampm_select").chosen({
		disable_search_threshold: 10
	});
	
    var toSet = new Date();
    
	function setNewTime() {
    	var ampm = $("#ampm_select").val();
    	var hour = parseInt($("#hour_select").val());
    	var min = parseInt($("#minute_select").val());
    	if(ampm == "AM") {
    		if (hour == 12)
    			toSet.setHours(0);
    		else
    			toSet.setHours(hour);
    	} else {
    		if (hour == 12)
    			toSet.setHours(12);
    		else
    			toSet.setHours(hour + 12);
    	}
    	toSet.setMinutes(min);
    	toSet.setSeconds(0);
    	
		$("#${field.cssname}").attr("value", webapp.helpers.date_to_format_string(toSet));
    }
    
    $("#${field.cssname}-display").datepicker({
        changeYear:true,
        changeMonth:true,
        dateFormat: "yy-mm-dd",
        altField: "#${field.cssname}",
        showButtonPanel: false,
        onSelect: function (dateText, inst) {
        	toSet.setDate(inst.selectedDay);
        	toSet.setFullYear(inst.selectedYear);
        	toSet.setMonth(inst.selectedMonth);
    		setNewTime();
	        console.log($("#${field.cssname}").val());
		}
    });
    
    $("#${field.cssname}-display").hide();
    $("#timepicker").hide();
    
    var now = new Date();
    var today = new Date();
	today.setHours(23);
	today.setMinutes(59);
	today.setSeconds(58);
	var tomorrow = new Date();
	tomorrow.setDate(tomorrow.getDate() + 1);
	tomorrow.setHours(23);
	tomorrow.setMinutes(59);
	tomorrow.setSeconds(58);
	var this_week = new Date();
	this_week.setDate(this_week.getDate() - this_week.getDay());
	this_week.setDate(this_week.getDate() + 6);
	this_week.setHours(23);
	this_week.setMinutes(59);
	this_week.setSeconds(58);
	var next_week = new Date();
	next_week.setDate(this_week.getDate() + 7);
	next_week.setHours(23);
	next_week.setMinutes(59);
	next_week.setSeconds(58);
	var later = new Date();
	later.setDate(next_week.getDate() + 7);
	later.setHours(23);
	later.setMinutes(59);
	later.setSeconds(58);
	
	var data = webapp.getController().currentView.data;
    if (data.due_date) {
		$("#${field.cssname}").attr("value", data.due_date);
		var current = new Date();
		current.setTime(Date.parse(data.due_date));
		if (current <= today) {
			$("#date_select :nth-child(1)").attr('selected', 'selected');
			$("#date_select").trigger("liszt:updated");
		} else if (current <= tomorrow) {
			$("#date_select :nth-child(2)").attr('selected', 'selected');
			$("#date_select").trigger("liszt:updated");
		} else if (current <= this_week) {
			$("#date_select :nth-child(3)").attr('selected', 'selected');
			$("#date_select").trigger("liszt:updated");
		} else if (current <= next_week) {
			$("#date_select :nth-child(4)").attr('selected', 'selected');
			$("#date_select").trigger("liszt:updated");
		} else if (current <= later) {
			$("#date_select :nth-child(5)").attr('selected', 'selected');
			$("#date_select").trigger("liszt:updated");
		} else {
			$("#${field.cssname}-display").datepicker('setDate', current);
			
			$("#date_select :nth-child(6)").attr('selected', 'selected');
			$("#date_select").trigger("liszt:updated");
			
			$("#hour_select :nth-child(" + (current.getUTCHours() - 12) + ")").attr('selected', 'selected');
			$("#hour_select").trigger("liszt:updated");
			
			if (current.getUTCMinutes() == 0) {
				$("#minute_select :nth-child(1)").attr('selected', 'selected');
			} else if (current.getUTCMinutes() == 15) {
				$("#minute_select :nth-child(2)").attr('selected', 'selected');
			} else if (current.getUTCMinutes() == 30) {
				$("#minute_select :nth-child(3)").attr('selected', 'selected');
			} else {
				$("#minute_select :nth-child(4)").attr('selected', 'selected');
			}
			$("#minute_select").trigger("liszt:updated");
			
			if(current.getUTCHours() > 11) {
				$("#ampm_select :nth-child(2)").attr('selected', 'selected');
				$("#ampm_select").trigger("liszt:updated");
			}
			
			$("#${field.cssname}-display").show();
    		$("#timepicker").show();
		}
    } else {
		$("#${field.cssname}").attr("value", webapp.helpers.date_to_format_string(today));
    }
    
    $("#date_select").change(function() {
    	if ($(this).val() == "datepicker") {
			$("#${field.cssname}-display").show();
			$("#timepicker").show();
    	} else {
    		var dateText;
    		
			$("#${field.cssname}-display").hide();
			$("#timepicker").hide();
			
			if ($(this).val() == "today") {
				dateText = webapp.helpers.date_to_format_string(today);
			} else if ($(this).val() == "tomorrow") {
				dateText = webapp.helpers.date_to_format_string(tomorrow);
			} else if ($(this).val() == "this week") {
				dateText = webapp.helpers.date_to_format_string(this_week);
			} else if ($(this).val() == "next week") {
				dateText = webapp.helpers.date_to_format_string(next_week);
			} else if ($(this).val() == "later") {
				dateText = webapp.helpers.date_to_format_string(later);
			}
			
    		$("#${field.cssname}").attr("value", dateText);
    		console.log($("#${field.cssname}").val());
    	}
    });
    
    
    
    $("#hour_select").change(function() {
    	setNewTime();
    });$("#minute_select").change(function() {
    	setNewTime();
    });$("#ampm_select").change(function() {
    	setNewTime();
    });
</script>

